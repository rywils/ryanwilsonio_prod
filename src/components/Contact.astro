---
// Contact.astro
export const prerender = false;

import { Mail, Send } from '@lucide/astro';

// compact=false (default): full layout (homepage)
// compact=true: hide side blocks + top header (contact page)
const { compact = false } = Astro.props;

const contactInfo = [
  {
    icon: Mail,
    label: 'Email',
    value: 'hello@ryanwilson.io',
    href: 'mailto:hello@ryanwilson.io',
  },
];
---

<section
  id="contact"
  class="py-20 px-4 sm:px-6 lg:px-8 relative overflow-hidden border-b-1 border-[#10191d] shadow-md shadow-[#0a0a0a]"
>
  <div class="absolute inset-0 bg-gradient-to-b from-transparent via-primary-blue/5 to-transparent pointer-events-none"></div>

  <div class={`mx-auto relative z-10 contact-container ${compact ? 'max-w-3xl' : 'max-w-6xl'}`}>

    <!-- TOP HEADER (HIDDEN WHEN COMPACT) -->
    {!compact && (
      <div class="text-center mb-16">
        <h2
          id="contact-heading"
          class="text-4xl sm:text-5xl md:text-6xl mb-4 contact-title text-(--primary-green) contact-info"
        >
          Get In Touch
        </h2>
        <div
          id="contact-underline"
          class="h-1 w-20 bg-gradient-to-r from-[var(--primary-blue)] to-[var(--primary-green)] mx-auto rounded-full mt-4 contact-info"
        ></div>
        <p
          id="contact-subtitle"
          class="text-muted-foreground max-w-2xl mx-auto contact-subtitle contact-info pt-4"
        >
          Have a project in mind or want to collaborate? Feel free to reach out!
        </p>
      </div>
    )}

    <div
      id="contact-grid"
      class={`grid gap-12 ${compact ? 'grid-cols-1' : 'lg:grid-cols-5'}`}
    >

      <!-- LEFT SIDE INFO (HIDDEN WHEN COMPACT) -->
      {!compact && (
        <div id="contact-info" class="lg:col-span-2 space-y-6">
          <div id="contact-secondary-heading-block" class="contact-info">
            <h3 class="text-2xl mb-4 font-semibold text-(--primary-blue) contact-secondary-heading contact-info">
              Let's Connect
            </h3>
            <p
              id="contact-info-first"
              class="text-muted-foreground mb-6 contact-info"
            >
              I'm always interested in hearing about new projects and opportunities.
              Whether you have a question or just want to say hi, I'll try my best to
              get back to you!
            </p>
          </div>

          <div id="contact-email" class="space-y-12 contact-info">
            {contactInfo.map((info, index) => {
              const Icon = info.icon;
              return (
                <>
                  <p
                    id="contact-email-subtitle"
                    class="text-muted-foreground text-md contact-info"
                  >
                    If you'd rather contact me via email instead of through the contact form,
                    feel free to do so!
                  </p>

                  <a
                    href={info.href}
                    class="contact-info-card flex items-center gap-4 p-4 rounded-xl bg-gradient-to-br from-(--primary-blue)/10 to-(--secondary-purple)/10 border border-(--primary-blue)/20 hover:border-primary-blue/50 transition-all hover:translate-x-1 hover:glow-(--primary-blue) group"
                    style={`--info-delay: ${0.7 + index * 0.1}s`}
                  >
                    <div class="p-3 rounded-full bg-(--primary-blue)/10 border border-(--primary-blue)/30 group-hover:bg-(--primary-blue)/20 transition-colors">
                      <Icon class="w-5 h-5 text-primary-blue" />
                    </div>
                    <div>
                      <p class="text-sm text-muted-foreground contact-info">{info.label}</p>
                      <p class="group-hover:text-(--primary-blue) transition-colors contact-info">
                        {info.value}
                      </p>
                    </div>
                  </a>
                </>
              );
            })}
          </div>

          <div
            id="contact-info-third"
            class="contact-info contact-response-card p-6 rounded-xl bg-gradient-to-br from-(--primary-blue)/10 to-(--secondary-purple)/10 border border-(--primary-blue)/30"
          >
            <h4 class="mb-2 font-semibold text-(--primary-blue)">Quick Response</h4>
            <p class="text-sm text-muted-foreground">
              I typically respond within 24 hours on business days
            </p>
          </div>
        </div>
      )}

      <!-- FORM (ALWAYS RENDERS) -->
      <div class={compact ? 'contact-form w-full mx-auto' : 'lg:col-span-3 contact-form'}>
        <form id="contact-form" class="space-y-6">
          <div class="grid sm:grid-cols-2 gap-6">
            <div class="contact-field">
              <label for="name" class="block mb-2">Name</label>
              <input
                id="name"
                name="name"
                type="text"
                placeholder="Your name"
                required
                class="w-full px-4 py-3 rounded-lg bg-background border border-(--primary-blue)/20 focus:border-(--primary-blue) focus:outline-none focus:ring-2 focus:ring-(--primary-blue)/20 transition-colors"
              />
            </div>

            <div class="contact-field" style="--field-delay: 0.1s">
              <label for="email" class="block mb-2">Email</label>
              <input
                id="email"
                name="email"
                type="email"
                placeholder="your.email@example.com"
                required
                class="w-full px-4 py-3 rounded-lg bg-background border border-(--primary-blue)/20 focus:border-primary-blue focus:outline-none focus:ring-2 focus:ring-primary-blue/20 transition-colors"
              />
            </div>
          </div>

          <div class="contact-field" style="--field-delay: 0.2s">
            <label for="reason" class="block mb-2">Reason for Contact</label>
            <select
              id="reason"
              name="reason"
              required
              class="w-full px-4 py-3 rounded-lg bg-background border border-(--primary-blue)/20 focus:border-primary-blue focus:outline-none focus:ring-2 focus:ring-primary-blue/20 transition-colors"
            >
              <option value="inquiry">Inquiry</option>
              <option value="employer">Employer</option>
              <option value="collaboration">Collaboration</option>
            </select>
          </div>

          <div class="contact-field" style="--field-delay: 0.3s">
            <label for="message" class="block mb-2">Message</label>
            <textarea
              id="message"
              name="message"
              placeholder="Tell me about your project or opportunity..."
              required
              rows="6"
              class="w-full px-4 py-3 rounded-lg bg-background border border-(--primary-blue)/20 focus:border-(--primary-blue) focus:outline-none focus:ring-2 focus:ring-primary-blue/20 transition-colors resize-none"
            ></textarea>
          </div>

          <!-- BUTTON: homepage keeps your layout; compact centers -->
          <div
            id="contact-submit"
            class={`contact-submit ${compact ? 'w-full flex justify-center' : ''}`}
          >
            <button
              type="submit"
              id="submit-button"
              class="w-full sm:w-auto px-8 py-3 bg-transparent rounded-lg glow-primary-blue flex items-center justify-center gap-2 hover:bg-secondary-purple hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed text-(--primary-blue)"
            >
              <Send size={20} />
              <span id="button-text" class="text-(--primary-blue)">Send Message</span>
            </button>
          </div>

          <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
        </form>
      </div>
    </div>
  </div>
</section>

<script is:inline>
  if (typeof window !== 'undefined') {
    const observerOptions = { threshold: 0.3, rootMargin: '0px' };
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('in-view');
          observer.unobserve(entry.target);
        }
      });
    }, observerOptions);

    function setupObserver() {
      const section = document.querySelector('#contact .contact-container');
      if (section) observer.observe(section);
    }

    function showToast(message, type) {
      const container = document.getElementById('toast-container');
      if (!container) return;
      const toast = document.createElement('div');
      toast.className = `px-6 py-3 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
      }`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => container.removeChild(toast), 4000);
    }

    function setupForm() {
      const form = document.getElementById('contact-form');
      if (!form) return;

      if (form.dataset.bound === 'true') return;
      form.dataset.bound = 'true';

      const submitButton = document.getElementById('submit-button');
      const buttonText = document.getElementById('button-text');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitButton.disabled = true;
        buttonText.textContent = 'Sending...';

        try {
          const response = await fetch('/api/contact', {
            method: 'POST',
            body: new FormData(form),
          });

          if (response.ok) {
            showToast("Message sent! I'll get back to you soon.", 'success');
            form.reset();
          } else {
            showToast('Failed to send message. Please try again.', 'error');
          }
        } catch {
          showToast('Network error. Please try again.', 'error');
        } finally {
          submitButton.disabled = false;
          buttonText.textContent = 'Send Message';
        }
      });
    }

    document.addEventListener('astro:page-load', () => {
      setupObserver();
      setupForm();
    });

    setupObserver();
    setupForm();
  }
</script>
