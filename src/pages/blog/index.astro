---
// src/pages/blog/index.astro
import Layout from '../../layouts/Layout.astro';
import { Calendar, Clock, User, ArrowRight, ChevronDown } from '@lucide/astro';
import { getCollection } from 'astro:content';
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

// Sort posts by date
const sortedPosts = allPosts.sort((a, b) => {
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});

// Dynamically extract unique categories from posts
const categoriesSet = new Set<string>();
sortedPosts.forEach(post => {
  const category = post.data.category;
  if (Array.isArray(category)) {
    category.forEach(cat => categoriesSet.add(cat));
  } else if (category) {
    categoriesSet.add(category);
  }
});

// Convert to sorted array with "All" at the beginning
const categories = ['All', ...Array.from(categoriesSet).sort()];

// Helper function to get preview text and strip markdown
function getPreview(content: string, wordCount: number = 50): string {
  // Strip markdown syntax
  const stripped = content
    .replace(/#{1,6}\s/g, '') // Remove headers
    .replace(/\*\*|__/g, '') // Remove bold
    .replace(/\*|_/g, '') // Remove italic
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1') // Remove links but keep text
    .replace(/`{1,3}[^`]*`{1,3}/g, '') // Remove code blocks
    .replace(/>\s/g, '') // Remove blockquotes
    .replace(/[-*+]\s/g, '') // Remove list markers
    .trim();
  
  const words = stripped.split(/\s+/);
  if (words.length <= wordCount) {
    return stripped;
  }
  return words.slice(0, wordCount).join(' ') + '...';
}
---

<Layout title="Blog" description="Thoughts, ideas, tutorials, writeups, all right here.">
  <section class="mt-10 pb-20 px-4 sm:px-6 lg:px-8 relative overflow-hidden min-h-screen">
    <div class="absolute inset-0  pointer-events-none"></div>
    
    <div class="max-w-7xl mx-auto relative z-10">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-5xl sm:text-6xl md:text-6xl mb-4 text-[var(--primary-green)] font-bold">
          All Blog Posts
        </h1>
        <div class="h-1 w-24 bg-gradient-to-r from-[var(--primary-green)] to-[var(--primary-blue)] mx-auto rounded-full"></div>
        <p class="mt-6 text-xl text-muted-foreground max-w-2xl mx-auto">
          Insights, tutorials, and thoughts on web development, cyber security, linux, cloud, and all things tech.
        </p>
      </div>

      <!-- Category Dropdown -->
      <div class="flex justify-center mb-12">
        <div class="relative inline-block w-full max-w-xs">
          <button
            id="category-dropdown-btn"
            type="button"
            class="flex items-center gap-3 px-6 py-3 rounded-full border-2 border-[var(--primary-green)] text-[var(--primary-green)] hover:bg-[var(--primary-green)]/10 transition-all hover:scale-105 active:scale-95 font-semibold w-full justify-between"
          >
            <span id="selected-category">All Categories</span>
            <ChevronDown size={20} id="dropdown-icon" />
          </button>
          
          <div
            id="category-dropdown-menu"
            class="dropdown-menu absolute top-full mt-2 left-0 right-0 bg-[#0a0a0a] border border-[var(--primary-green)]/30 rounded-xl overflow-hidden shadow-xl z-50"
          >
            {categories.map((category) => (
              <button
                type="button"
                class="category-option w-full px-6 py-3 text-left hover:bg-[var(--primary-green)]/10 transition-colors border-b border-[var(--primary-green)]/10 last:border-b-0 text-[var(--primary-green)]"
                data-category={category}
              >
                {category === 'All' ? 'All Categories' : category}
              </button>
            ))}
          </div>
        </div>
      </div>

      <!-- Coming Soon Message -->
      <h3 id="comingSoon" class="hidden text-center text-3xl text-[var(--primary-green)] col-span-full py-20">
        Coming Soon!
      </h3>

      <!-- Blog List - Horizontal Cards -->
<div class="flex flex-col gap-6" id="blog-grid">
          {sortedPosts.map((post, index) => (
          <a
            href={`/blog/${post.slug}`}
            class="blog-card group rounded-xl overflow-hidden bg-card border border-[var(--primary-blue)]/20 hover:border-[var(--primary-green)]/50 transition-all hover:scale-[1.01] block"
            data-category={JSON.stringify(post.data.category)}
            style={`--blog-delay: ${0.1 + index * 0.1}s`}
            data-astro-prefetch
          >
            <div class="p-5">
              <div class="flex items-center justify-between mb-3">
                <div class="flex flex-wrap gap-2">
                  {Array.isArray(post.data.category) ? (
                    post.data.category.map((cat) => (
                      <span class="px-3 py-1 rounded-full bg-[var(--primary-blue)]/20 text-xs">
                        {cat}
                      </span>
                    ))
                  ) : (
                    <span class="px-3 py-1 rounded-full bg-[var(--primary-blue)]/20 text-xs">
                      {post.data.category}
                    </span>
                  )}
                </div>
                
                <div class="flex items-center gap-4 text-xs text-muted-foreground">
                  <span class="flex items-center gap-1">
                    <Calendar size={12} />
                    {post.data.date}
                  </span>
                  <span class="flex items-center gap-1">
                    <Clock size={12} />
                    {post.data.readTime}
                  </span>
                </div>
              </div>

              <h3 class="text-xl mb-2 text-[var(--primary-blue)] group-hover:text-[var(--primary-green)] transition-colors font-semibold">
                {post.data.title}
              </h3>

              <p class="text-sm text-muted-foreground mb-3 line-clamp-3">
                {getPreview(post.body, 50)}
              </p>

              <div class="flex items-center justify-between">
                <span class="flex items-center gap-1 text-sm text-muted-foreground">
                  <User size={14} />
                  {post.data.author}
                </span>
                
                <span class="flex items-center gap-2 text-sm text-[var(--primary-blue)] group-hover:text-[var(--primary-green)] transition-all font-medium">
                  Read More
                  <ArrowRight size={14} class="group-hover:translate-x-1 transition-transform" />
                </span>
              </div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>
</Layout>

<script>
  function initFilters() {
    const dropdownBtn = document.getElementById('category-dropdown-btn');
    const dropdownMenu = document.getElementById('category-dropdown-menu');
    const dropdownIcon = document.getElementById('dropdown-icon');
    const selectedCategoryText = document.getElementById('selected-category');
    const categoryOptions = document.querySelectorAll('.category-option') as NodeListOf<HTMLElement>;
    const blogCards = document.querySelectorAll('.blog-card') as NodeListOf<HTMLElement>;
    const comingSoon = document.getElementById('comingSoon');
    
      if (!dropdownBtn || !dropdownMenu || !dropdownIcon || !selectedCategoryText) {
        console.error('Dropdown elements not found');
        return;
      }
      
    // FORCE SHOW ALL CARDS IMMEDIATELY
    blogCards.forEach(card => {
      card.style.opacity = '1';
      card.style.transform = 'scale(1)';
    });
    
    let isOpen = false;
    
    // Toggle dropdown
    dropdownBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      isOpen = !isOpen;
      
      if (isOpen) {
        dropdownMenu.style.display = 'block';
        dropdownIcon.style.transform = 'rotate(180deg)';
      } else {
        dropdownMenu.style.display = 'none';
        dropdownIcon.style.transform = 'rotate(0deg)';
      }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!dropdownBtn.contains(e.target as Node) && !dropdownMenu.contains(e.target as Node)) {
        isOpen = false;
        dropdownMenu.style.display = 'none';
        dropdownIcon.style.transform = 'rotate(0deg)';
      }
    });
    
    // Filter blog posts
    categoryOptions.forEach(option => {
      option.addEventListener('click', (e) => {
        e.stopPropagation();
        const category = option.getAttribute('data-category');
        
        console.log('Selected category:', category);
        
        // Update selected category text
        if (selectedCategoryText) {
          selectedCategoryText.textContent = category === 'All' ? 'All Categories' : category || 'All Categories';
        }
        
        // Close dropdown
        isOpen = false;
        dropdownMenu.style.display = 'none';
        dropdownIcon.style.transform = 'rotate(0deg)';
        
        // Filter blog posts
        let visibleCount = 0;
        blogCards.forEach(card => {
          const cardCategory = card.getAttribute('data-category');
          
          // Handle both single category (string) and multiple categories (array)
          let shouldShow = false;
          if (category === 'All') {
            shouldShow = true;
          } else if (cardCategory) {
            try {
              // Try parsing as JSON array first
              const categories = JSON.parse(cardCategory);
              shouldShow = Array.isArray(categories) && categories.includes(category);
            } catch {
              // Fall back to string comparison for single categories
              shouldShow = cardCategory === category;
            }
          }
          
          if (shouldShow) {
            card.style.display = 'block';
            card.style.opacity = '1';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        // Show/hide "Coming Soon" message
        if (comingSoon) {
          if (visibleCount === 0) {
            comingSoon.classList.remove('hidden');
          } else {
            comingSoon.classList.add('hidden');
          }
        }
      });
    });
  }

  // Run on initial page load
  document.addEventListener('DOMContentLoaded', initFilters);
  
  // Run after view transitions
  document.addEventListener('astro:page-load', initFilters);
</script>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .dropdown-menu {
    display: none;
    max-height: 300px;
    overflow-y: auto;
  }

  .dropdown-menu::-webkit-scrollbar {
    width: 6px;
  }

  .dropdown-menu::-webkit-scrollbar-track {
    background: transparent;
  }

  .dropdown-menu::-webkit-scrollbar-thumb {
    background: var(--primary-green);
    border-radius: 3px;
  }

  .dropdown-menu::-webkit-scrollbar-thumb:hover {
    background: var(--primary-blue);
  }

  #dropdown-icon {
    transition: transform 0.2s ease;
  }
</style>
